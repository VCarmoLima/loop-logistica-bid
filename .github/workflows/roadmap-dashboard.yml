name: Roadmap Dashboard

on:
  push:
    branches:
      - main
    paths:
      - ROADMAP.md

  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate SVG Progress
        shell: bash
        run: |
          set -e

          # Count tasks
          TOTAL=$(grep -o "\- \[.\]" ROADMAP.md | wc -l || echo 0)
          DONE=$(grep -o "\- \[x\]" ROADMAP.md | wc -l || echo 0)

          if [ "$TOTAL" -eq 0 ]; then
            PERCENT=0
          else
            PERCENT=$((100 * DONE / TOTAL))
          fi

          # SVG dimensions
          BAR_WIDTH=540
          FILLED_WIDTH=$((BAR_WIDTH * PERCENT / 100))

          mkdir -p assets

          cat <<EOF > assets/roadmap-progress.svg
          <svg width="600" height="140" viewBox="0 0 600 140" xmlns="http://www.w3.org/2000/svg">
            <style>
              .title {
                font: 600 20px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                fill: #e5e7eb;
              }
              .subtitle {
                font: 14px system-ui, sans-serif;
                fill: #9ca3af;
              }
              .label {
                font: 13px system-ui, sans-serif;
                fill: #d1d5db;
              }
            </style>

            <text x="30" y="30" class="title">ðŸ“Š Progresso do Roadmap</text>
            <text x="30" y="52" class="subtitle">Sistema de BIDs</text>

            <rect x="30" y="75" width="$BAR_WIDTH" height="18" rx="9" fill="#1f2933"/>
            <rect x="30" y="75" width="$FILLED_WIDTH" height="18" rx="9" fill="#22c55e"/>

            <text x="30" y="118" class="label">
              $DONE de $TOTAL tarefas concluÃ­das â€” $PERCENT%
            </text>
          </svg>
          EOF

      - name: Commit SVG
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add assets/roadmap-progress.svg
          git commit -m "chore: update roadmap dashboard" || echo "No changes to commit"
          git push
